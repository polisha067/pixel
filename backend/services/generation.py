"""
Сервис генерации ответов на письма.

Этот модуль отвечает за:
- Выбор подходящего агента по категории письма
- Генерацию черновика ответа с помощью нейросети
- Использование правильного стиля для каждой категории

Агенты - это специализированные помощники, каждый из которых
генерирует ответы в своем стиле, подходящем для определенной категории услуг.
"""

from backend.agents.credit_agent import CreditAgent
from backend.agents.insurance_agent import InsuranceAgent
from backend.agents.general_agent import GeneralAgent


# Словарь соответствий: категория → агент
# Когда письмо классифицировано по категории, выбирается соответствующий агент
AGENTS_BY_CATEGORY = {
    "credit": CreditAgent(),           # Кредиты → CreditAgent
    "insurance": InsuranceAgent(),      # Страхование → InsuranceAgent
    # Для остальных категорий используем универсальный агент
    # Можно добавить больше специализированных агентов:
    # "mortgage": MortgageAgent(),
    # "deposit": DepositAgent(),
    # и т.д.
}


def generate_draft_response(letter_text: str, category: str) -> str:
    """
    Генерирует черновик ответа на письмо.
    
    Это основная функция для генерации ответов.
    Она:
    1. Выбирает подходящего агента по категории письма
    2. Использует агента для генерации ответа
    3. Возвращает черновик, который сотрудник может редактировать
    
    Args:
        letter_text: Текст входящего письма от пользователя
        category: Категория услуги (credit, insurance, mortgage и т.д.)
    
    Returns:
        str: Черновик ответа, сгенерированный нейросетью
    
    Пример:
        draft = generate_draft_response(
            "Хочу оформить кредит на машину",
            "credit"
        )
        print(draft)  # "Уважаемый клиент! Благодарим за обращение..."
    """
    # Выбираем агента по категории
    # Если для категории есть специализированный агент - используем его
    # Если нет - используем универсальный GeneralAgent
    agent = AGENTS_BY_CATEGORY.get(category, GeneralAgent())
    
    try:
        # Генерируем ответ с помощью выбранного агента
        # Агент сам знает, какой стиль использовать
        draft_response = agent.generate_response(letter_text)
        
        return draft_response
    
    except Exception as e:
        # Если произошла ошибка при генерации, возвращаем базовый ответ
        print(f"❌ Ошибка при генерации ответа: {str(e)}")
        return f"""Уважаемый клиент!

Благодарим Вас за обращение в наш банк.

Мы получили Ваше письмо и обязательно рассмотрим его в ближайшее время.
Наш специалист свяжется с Вами для уточнения деталей и решения Вашего вопроса.

С уважением,
Команда банка"""


def get_agent_for_category(category: str):
    """
    Получает агента для определенной категории.
    
    Используется для получения информации об агенте
    или для прямого использования агента.
    
    Args:
        category: Категория услуги
    
    Returns:
        BaseAgent: Агент для этой категории
    """
    return AGENTS_BY_CATEGORY.get(category, GeneralAgent())

