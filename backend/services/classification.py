"""
Сервис классификации писем по категориям банковских услуг.

Этот модуль определяет, к какой категории банковских услуг относится письмо:
- credit (кредиты)
- insurance (страхование: ОСАГО, КАСКО и т.д.)
- mortgage (ипотека)
- deposit (вклады)
- cards (банковские карты)
- и т.д.

Классификация выполняется с помощью YandexGPT на основе анализа текста письма.
"""

from backend.services.yandex_ai import send_request_to_yandex
from backend.config import settings


def classify_letter(text: str) -> str:
    """
    Определяет категорию банковской услуги для письма.
    
    Анализирует текст письма и определяет, к какой категории услуг оно относится.
    Это ключевая функция для маршрутизации - по категории определяется,
    какому сотруднику направить письмо.
    
    Args:
        text: Текст письма от пользователя
    
    Returns:
        str: Категория услуги (credit, insurance, mortgage, deposit, cards и т.д.)
    
    Пример:
        category = classify_letter("Хочу оформить кредит на машину")
        print(category)  # "credit"
    """
    # Формируем промпт для классификации
    # Промпт - это инструкция для нейросети, что именно нужно сделать
    prompt = f"""Проанализируй следующее письмо и определи, к какой категории банковских услуг оно относится.

Доступные категории:
- credit - оформление кредитов (потребительские, автокредиты, кредитные карты)
- insurance - страхование (ОСАГО, КАСКО, страхование жизни, имущества)
- mortgage - ипотека (ипотечные кредиты, рефинансирование ипотеки)
- deposit - вклады и депозиты (открытие вклада, пополнение, закрытие)
- cards - банковские карты (оформление, блокировка, замена карты)
- business - бизнес-услуги (расчетный счет, бизнес-кредиты, эквайринг)
- investment - инвестиции (брокерский счет, инвестиционные продукты)
- online_banking - интернет-банкинг (вход, восстановление доступа, настройки)
- currency - валютные операции (обмен валют, валютные переводы)
- other - прочее (не относится ни к одной категории)

Ответь ТОЛЬКО одним словом - названием категории (например: credit, insurance, mortgage).

Письмо:
{text}

Категория:"""

    try:
        # Отправляем запрос к нейросети
        # temperature=0.3 - низкая температура для более точной классификации
        response = send_request_to_yandex(prompt, temperature=0.3)
        
        # Очищаем ответ - убираем лишние пробелы и приводим к нижнему регистру
        category = response.strip().lower()
        
        # Проверяем, что категория валидна (существует в списке)
        if category not in settings.BANK_CATEGORIES:
            # Если нейросеть вернула неверную категорию, используем "other"
            print(f"⚠️ Нейросеть вернула неверную категорию: {category}. Используем 'other'")
            category = "other"
        
        return category
    
    except Exception as e:
        # Если произошла ошибка при классификации, используем категорию "other"
        print(f"❌ Ошибка при классификации письма: {str(e)}")
        print("Используем категорию 'other' по умолчанию")
        return "other"


def get_category_name(category: str) -> str:
    """
    Получает человекочитаемое название категории.
    
    Преобразует техническое название категории (например, "credit")
    в понятное название на русском языке (например, "Кредиты").
    
    Args:
        category: Техническое название категории
    
    Returns:
        str: Человекочитаемое название
    
    Пример:
        name = get_category_name("credit")
        print(name)  # "Кредиты"
    """
    # Словарь соответствий: техническое название → русское название
    category_names = {
        "credit": "Кредиты",
        "insurance": "Страхование",
        "mortgage": "Ипотека",
        "deposit": "Вклады и депозиты",
        "cards": "Банковские карты",
        "business": "Бизнес-услуги",
        "investment": "Инвестиции",
        "online_banking": "Интернет-банкинг",
        "currency": "Валютные операции",
        "other": "Прочее"
    }
    
    # Возвращаем русское название или само значение, если не найдено
    return category_names.get(category, category)


def validate_category(category: str) -> bool:
    """
    Проверяет, является ли категория валидной.
    
    Args:
        category: Название категории для проверки
    
    Returns:
        bool: True если категория валидна, False если нет
    """
    return category in settings.BANK_CATEGORIES

