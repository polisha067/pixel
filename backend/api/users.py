"""
API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫–ª–∏–µ–Ω—Ç–æ–≤ –±–∞–Ω–∫–∞).

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è:
- –û—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π
- –ü—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–≤–æ–∏—Ö –ø–∏—Å–µ–º
- –ü—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Å–≤–æ–∏ –ø–∏—Å—å–º–∞
"""

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from backend.database.database import get_db
from backend.database import crud
from backend.schemas.letter import LetterCreate, LetterResponse
from backend.services.classification import classify_letter
from backend.services.generation import generate_draft_response
from backend.services.routing import route_letter

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
router = APIRouter(prefix="/api/users", tags=["users"])


@router.post("/letters", response_model=LetterResponse)
def create_letter(letter_data: LetterCreate, user_id: int, db: Session = Depends(get_db)):
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ –±–∞–Ω–∫.
    
    –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∏—Å—å–º–æ, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
    1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–∏—Å—å–º–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–µ–π—Ä–æ—Å–µ—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é)
    2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –æ—Ç–≤–µ—Ç–∞ (–Ω–µ–π—Ä–æ—Å–µ—Ç—å —Å–æ–∑–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç)
    3. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É (–Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
    4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    
    Args:
        letter_data: –î–∞–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ (—Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è)
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–ø—Ä–æ—Å–µ)
        db: –°–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    
    Returns:
        LetterResponse: –°–æ–∑–¥–∞–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ —Å–æ –≤—Å–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    
    Raises:
        HTTPException: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    user = crud.get_user_by_id(db, user_id)
    if not user:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    try:
        # ========== –®–ê–ì 1: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è ==========
        # –ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —É—Å–ª—É–≥–∏
        print(f"üîç –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É—é –ø–∏—Å—å–º–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}...")
        category = classify_letter(letter_data.text)
        print(f"‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞: {category}")
        
        # ========== –®–ê–ì 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –æ—Ç–≤–µ—Ç–∞ ==========
        # –ù–µ–π—Ä–æ—Å–µ—Ç—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–≤–µ—Ç–∞ –≤ –ø–æ–¥—Ö–æ–¥—è—â–µ–º —Å—Ç–∏–ª–µ
        print(f"‚úçÔ∏è –ì–µ–Ω–µ—Ä–∏—Ä—É—é —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–≤–µ—Ç–∞...")
        draft_response = generate_draft_response(letter_data.text, category)
        print(f"‚úÖ –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
        
        # ========== –®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ –ø–∏—Å—å–º–∞ –≤ –ë–î ==========
        # –°–æ–∑–¥–∞–µ–º –ø–∏—Å—å–º–æ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –∏ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–º
        letter = crud.create_letter(
            db=db,
            text=letter_data.text,
            user_id=user_id,
            category=category,
            draft_response=draft_response
        )
        
        # ========== –®–ê–ì 4: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É ==========
        # –ù–∞—Ö–æ–¥–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º –µ–º—É –ø–∏—Å—å–º–æ
        try:
            print(f"üì¨ –ù–∞–∑–Ω–∞—á–∞—é –ø–∏—Å—å–º–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {category}...")
            employee = route_letter(db, letter.id, category)
            print(f"‚úÖ –ü–∏—Å—å–º–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É: {employee.user.name}")
        except ValueError as e:
            # –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–∏—Å—å–º–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
            print(f"‚ö†Ô∏è {str(e)}")
            print("–ü–∏—Å—å–º–æ —Å–æ–∑–¥–∞–Ω–æ, –Ω–æ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        db.refresh(letter)
        
        return letter
    
    except Exception as e:
        # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É 500
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∏—Å—å–º–∞: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–∏—Å—å–º–∞: {str(e)}")


@router.get("/letters", response_model=List[LetterResponse])
def get_user_letters(user_id: int, db: Session = Depends(get_db)):
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–∏—Å—å–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∏—Å–µ–º, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º,
    –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏).
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db: –°–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    
    Returns:
        List[LetterResponse]: –°–ø–∏—Å–æ–∫ –ø–∏—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    user = crud.get_user_by_id(db, user_id)
    if not user:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–∏—Å—å–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    letters = crud.get_letters_by_user(db, user_id)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
    letters.sort(key=lambda x: x.created_at, reverse=True)
    
    return letters


@router.get("/letters/{letter_id}", response_model=LetterResponse)
def get_user_letter(letter_id: int, user_id: int, db: Session = Depends(get_db)):
    """
    –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø–∏—Å—å–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ —Å–≤–æ–µ–≥–æ –ø–∏—Å—å–º–∞,
    –≤–∫–ª—é—á–∞—è –æ—Ç–≤–µ—Ç –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–µ—Å–ª–∏ –æ–Ω —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω).
    
    Args:
        letter_id: ID –ø–∏—Å—å–º–∞
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞)
        db: –°–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    
    Returns:
        LetterResponse: –ü–∏—Å—å–º–æ
    
    Raises:
        HTTPException: –ï—Å–ª–∏ –ø–∏—Å—å–º–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    """
    # –ü–æ–ª—É—á–∞–µ–º –ø–∏—Å—å–º–æ
    letter = crud.get_letter_by_id(db, letter_id)
    
    if not letter:
        raise HTTPException(status_code=404, detail="–ü–∏—Å—å–º–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∏—Å—å–º–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if letter.user_id != user_id:
        raise HTTPException(status_code=403, detail="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –ø–∏—Å—å–º—É")
    
    return letter

