<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .loading-indicator {
            display: none;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
        .loading-indicator.active {
            display: block;
        }
        .response-editor {
            margin-top: 10px;
        }
        .response-editor textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }
        .response-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .letter-card {
            position: relative;
        }
        .generating-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 8px;
        }
        .generating-overlay.active {
            display: flex;
        }
        .generating-overlay .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üëî –ü–∞–Ω–µ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –±–∞–Ω–∫–∞</h1>
            <button class="btn btn-warning" onclick="logout()" style="float: right; margin-top: -50px;">–í—ã–π—Ç–∏</button>
        </header>

        <main>
            <section class="stats-section">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stats-card">
                    <p>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–∏—Å–µ–º: <strong id="completed-count">0</strong></p>
                </div>
            </section>

            <section class="letters-section">
                <h2>üì¨ –í—Å–µ –ø–∏—Å—å–º–∞</h2>
                <div id="letters-list"></div>
            </section>
        </main>
    </div>

    <script>
        const sessionId = localStorage.getItem('session_id');
        const currentUserIdStr = localStorage.getItem('user_id');
        const currentUserId = currentUserIdStr ? parseInt(currentUserIdStr, 10) : null;
        if (!sessionId) {
            window.location.href = '/login.html';
        }
        
        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ user_id –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        if (!currentUserId) {
            console.warn('user_id –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage. –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è.');
        }

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        const editingResponses = {};
        
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø–∏—Å–µ–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–∏–º
        let lettersData = [];

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ MSK
        function formatMSKTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU', { 
                timeZone: 'Europe/Moscow',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ textarea
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats', {
                    headers: {
                        'X-Session-ID': sessionId
                    }
                });
                const data = await response.json();
                document.getElementById('completed-count').textContent = data.total_completed;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadLetters() {
            try {
                const response = await fetch('/api/letters/all', {
                    headers: {
                        'X-Session-ID': sessionId
                    }
                });
                const data = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∏—Å–µ–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–∏–º
                lettersData = data.letters;
                
                const listDiv = document.getElementById('letters-list');
                if (data.letters.length === 0) {
                    listDiv.innerHTML = '<p>–ù–µ—Ç –ø–∏—Å–µ–º</p>';
                    return;
                }

                listDiv.innerHTML = data.letters.map(letter => {
                    const statusText = {
                        'pending': '‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏',
                        'in_work': 'üîÑ –í —Ä–∞–±–æ—Ç–µ',
                        'response_ready': '‚úÖ –û—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤',
                        'completed': '‚úîÔ∏è –ó–∞–≤–µ—Ä—à–µ–Ω–æ'
                    }[letter.status] || letter.status;

                    let actions = '';
                    let responseSection = '';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç
                    const isEditing = editingResponses[letter.id];
                    const currentResponse = isEditing !== undefined ? isEditing : (letter.response || '');

                    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
                    if (letter.status === 'in_work') {
                        console.log(`Letter ${letter.id}: status=${letter.status}, employee_id=${letter.employee_id} (${typeof letter.employee_id}), currentUserId=${currentUserId} (${typeof currentUserId}), match=${letter.employee_id == currentUserId}`);
                    }

                    if (letter.status === 'pending') {
                        actions = `<button class="btn btn-primary" onclick="takeLetter(${letter.id})">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>`;
                    } else if (letter.status === 'in_work') {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∏—Å—å–º–æ –≤–∑—è—Ç–æ —Ç–µ–∫—É—â–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º
                        // –ü—Ä–∏–≤–æ–¥–∏–º –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –∫ —á–∏—Å–ª–∞–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                        const letterEmployeeId = letter.employee_id != null ? Number(letter.employee_id) : null;
                        const myUserId = currentUserId != null ? Number(currentUserId) : null;
                        const isMyLetter = letterEmployeeId !== null && myUserId !== null && letterEmployeeId === myUserId;
                        
                        if (isMyLetter) {
                            // –ü–∏—Å—å–º–æ –≤–∑—è—Ç–æ —Ç–µ–∫—É—â–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º
                            // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∏–ª–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–∂–µ –µ—Å—Ç—å)
                            if (!letter.response) {
                                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –µ—â–µ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                                actions = `
                                    <div class="response-actions">
                                        <button class="btn btn-success" onclick="processLetter(${letter.id})" id="process-btn-${letter.id}">
                                            üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç
                                        </button>
                                    </div>
                                `;
                            } else {
                                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–∂–µ –µ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                                responseSection = `
                                    <div class="letter-response">
                                        <strong>–û—Ç–≤–µ—Ç:</strong>
                                        ${isEditing ? `
                                            <div class="response-editor">
                                                <textarea id="response-edit-${letter.id}">${currentResponse}</textarea>
                                                <div class="response-actions">
                                                    <button class="btn btn-primary" onclick="saveResponse(${letter.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                                    <button class="btn btn-secondary" onclick="cancelEdit(${letter.id})">–û—Ç–º–µ–Ω–∞</button>
                                                    <button class="btn btn-warning" onclick="regenerateResponse(${letter.id})">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                                                    <button class="btn btn-success" onclick="approveLetter(${letter.id})">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                                                </div>
                                            </div>
                                        ` : `
                                            <div id="response-display-${letter.id}">
                                                <p>${letter.response}</p>
                                                <div class="response-actions">
                                                    <button class="btn btn-primary" onclick="startEditFromButton(${letter.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                                    <button class="btn btn-warning" onclick="regenerateResponse(${letter.id})">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                                                    <button class="btn btn-success" onclick="approveLetter(${letter.id})">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                                                </div>
                                            </div>
                                        `}
                                    </div>
                                `;
                            }
                        } else {
                            // –ü–∏—Å—å–º–æ –≤–∑—è—Ç–æ –¥—Ä—É–≥–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º
                            actions = `<p style="color: #666;">–ü–∏—Å—å–º–æ –≤ —Ä–∞–±–æ—Ç–µ —É –¥—Ä—É–≥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</p>`;
                            if (letter.response) {
                                responseSection = `
                                    <div class="letter-response">
                                        <strong>–û—Ç–≤–µ—Ç:</strong>
                                        <p>${letter.response}</p>
                                    </div>
                                `;
                            }
                        }
                    } else if (letter.status === 'response_ready') {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∏—Å—å–º–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
                        const letterEmployeeId = letter.employee_id != null ? Number(letter.employee_id) : null;
                        const myUserId = currentUserId != null ? Number(currentUserId) : null;
                        const isMyLetter = letterEmployeeId !== null && myUserId !== null && letterEmployeeId === myUserId;
                        
                        if (isMyLetter) {
                        responseSection = `
                            <div class="letter-response">
                                <strong>–û—Ç–≤–µ—Ç:</strong>
                                ${isEditing ? `
                                    <div class="response-editor">
                                        <textarea id="response-edit-${letter.id}">${currentResponse}</textarea>
                                        <div class="response-actions">
                                            <button class="btn btn-primary" onclick="saveResponse(${letter.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                            <button class="btn btn-secondary" onclick="cancelEdit(${letter.id})">–û—Ç–º–µ–Ω–∞</button>
                                            <button class="btn btn-warning" onclick="regenerateResponse(${letter.id})">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                                            <button class="btn btn-success" onclick="approveLetter(${letter.id})">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                                        </div>
                                    </div>
                                ` : `
                                    <div id="response-display-${letter.id}">
                                        <p>${letter.response}</p>
                                        <div class="response-actions">
                                            <button class="btn btn-primary" onclick="startEditFromButton(${letter.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                            <button class="btn btn-warning" onclick="regenerateResponse(${letter.id})">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                                            <button class="btn btn-success" onclick="approveLetter(${letter.id})">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                                        </div>
                                    </div>
                                `}
                            </div>
                        `;
                        } else {
                            // –ü–∏—Å—å–º–æ –≥–æ—Ç–æ–≤–æ, –Ω–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –¥—Ä—É–≥–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç
                            responseSection = `
                                <div class="letter-response">
                                    <strong>–û—Ç–≤–µ—Ç:</strong>
                                    <p>${letter.response}</p>
                                    <p style="color: #666; font-size: 0.9em;">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥—Ä—É–≥–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º</p>
                                </div>
                            `;
                        }
                    }

                    return `
                        <div class="letter-card" id="letter-card-${letter.id}">
                            <div class="generating-overlay" id="generating-${letter.id}">
                                <div>
                                    <div class="spinner"></div>
                                    <p style="margin-top: 10px;">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç...</p>
                                </div>
                            </div>
                            <div class="letter-header">
                                <span class="letter-status">${statusText}</span>
                                <span class="letter-date">${formatMSKTime(letter.created_at)}</span>
                            </div>
                            <div class="letter-content">
                                <strong>–ü–∏—Å—å–º–æ:</strong>
                                <p>${letter.content}</p>
                            </div>
                            ${responseSection}
                            ${actions ? `<div class="letter-actions">${actions}</div>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading letters:', error);
            }
        }

        function showGenerating(letterId, show = true) {
            const overlay = document.getElementById(`generating-${letterId}`);
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        async function takeLetter(letterId) {
            try {
                const response = await fetch(`/api/letters/${letterId}/take`, {
                    method: 'POST',
                    headers: {
                        'X-Session-ID': sessionId
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    alert('–ü–∏—Å—å–º–æ –≤–∑—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É!');
                    loadLetters();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function processLetter(letterId) {
            if (!confirm('–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∏—Å—å–º–æ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç?')) return;

            showGenerating(letterId, true);
            const btn = document.getElementById(`process-btn-${letterId}`);
            if (btn) {
                btn.disabled = true;
                btn.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...';
            }

            try {
                const response = await fetch(`/api/letters/${letterId}/process`, {
                    method: 'POST',
                    headers: {
                        'X-Session-ID': sessionId
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    alert('–ü–∏—Å—å–º–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ! –û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.');
                    loadLetters();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                showGenerating(letterId, false);
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç';
                }
            }
        }

        function startEdit(letterId, currentResponse) {
            console.log('Starting edit for letter', letterId, 'with response:', currentResponse);
            if (!currentResponse) {
                console.error('No response provided for editing');
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            editingResponses[letterId] = currentResponse;
            loadLetters();
        }

        function startEditFromButton(letterId) {
            // –ù–∞—Ö–æ–¥–∏–º –ø–∏—Å—å–º–æ –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const letter = lettersData.find(l => l.id === letterId);
            if (letter && letter.response) {
                startEdit(letterId, letter.response);
            } else {
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ DOM
                const responseDisplay = document.getElementById(`response-display-${letterId}`);
                if (responseDisplay) {
                    const responseText = responseDisplay.querySelector('p');
                    if (responseText) {
                        const currentResponse = responseText.textContent || responseText.innerText;
                        startEdit(letterId, currentResponse);
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                    }
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
            }
        }

        function cancelEdit(letterId) {
            delete editingResponses[letterId];
            loadLetters();
        }

        async function saveResponse(letterId) {
            const textarea = document.getElementById(`response-edit-${letterId}`);
            if (!textarea) {
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            const newResponse = textarea.value.trim();
            if (!newResponse) {
                alert('–û—Ç–≤–µ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            try {
                const response = await fetch(`/api/letters/${letterId}/response`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': sessionId
                    },
                    body: JSON.stringify({
                        response: newResponse
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    delete editingResponses[letterId];
                    alert('–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    loadLetters();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function regenerateResponse(letterId) {
            if (!confirm('–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç? –¢–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω.')) return;

            showGenerating(letterId, true);

            try {
                const response = await fetch(`/api/letters/${letterId}/regenerate`, {
                    method: 'POST',
                    headers: {
                        'X-Session-ID': sessionId
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    delete editingResponses[letterId];
                    alert('–û—Ç–≤–µ—Ç –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!');
                    loadLetters();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                showGenerating(letterId, false);
            }
        }

        async function approveLetter(letterId) {
            if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø–∏—Å—å–º–æ?')) return;

            try {
                const response = await fetch(`/api/letters/${letterId}/approve`, {
                    method: 'POST',
                    headers: {
                        'X-Session-ID': sessionId
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    delete editingResponses[letterId];
                    alert('–ü–∏—Å—å–º–æ –æ–¥–æ–±—Ä–µ–Ω–æ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
                    loadLetters();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('session_id');
            localStorage.removeItem('user_type');
            localStorage.removeItem('user_id');
            window.location.href = '/';
        }

        loadStats();
        loadLetters();
        setInterval(() => {
            loadStats();
            loadLetters();
        }, 5000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    </script>
</body>
</html>
